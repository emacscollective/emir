:PREAMBLE:
#+STARTUP: overview
#+STARTUP: hideblocks
#+STARTUP: noindent
#+PROPERTY: header-args :results value table :noweb yes
:END:
* recreate ~packages~ table et al.
#+BEGIN_SRC emacs-lisp :results silent
  (let (old new)
    (closql-db 'epkg-database 'old (expand-file-name "old.sqlite" epkg-repository))
    (closql-db 'epkg-database 'new (expand-file-name "new.sqlite" epkg-repository))
    (emacsql-with-transaction new
      (dolist (obj (closql-entries old))
        (message "%s..." (oref obj name))
        (closql--resolve-slots obj)
        (pcase-let ((`(,class ,_db . ,rest)
                     (cl-coerce obj 'list)))
          (setq obj (vconcat (list class nil) rest)))
        (closql-insert new obj)))
    ;; (setq epkg-db-version 1)
    (emacsql new (format "PRAGMA user_version = %s" epkg-db-version)))
#+END_SRC
